# Spring, JPA, and Transactions

## Aims

In this exercise you will create an implementation of a Data Access Object (DAO) that takes full advantage of the Spring JPA support classes.

We have provided a starter project that has the required dependencies and already contains your entity classes, the DAO interface, and the Service layer class that you will need.

You will also use Java configuration to create this project.

## Create the new DAO

1. In your preferred IDE, open the `CompactDiscDAOWithJPAStarter` project which is located in the Solutions directory.

2. Open the Java class called `com.conygre.spring.boot.dao.SpringJPACompactDiscDAO`.

3. Note the commmented out interface implementation. This is so the project compiles before you complete the exercise. Now uncomment the implements and sort out the {}. 

4. In the `CompactDiscDAO` interface. Implement empty versions of the various methods.
   
5.	Declare a reference of type `EntityManager` with the name `em`.

6.	Annotate the reference as a `@PersistenceContext`. This will allow Spring to inject it.

7.	Within each method, use the injected EntityManager to carry out the required function. For example, the `getAllDiscs()` method is shown below:

```
	public Collection<CompactDisc> getAllDiscs() {
		Query query = em.createQuery("from CompactDisc");
		List<CompactDisc> discs = query.getResultList(); 
		return discs;
	}
```

## Configure the Required Beans in the Java configuration classes

1.	Open `com.conygre.spring.configuration.AppConfig.java` and you will now be adding the following configuration annotations:

    1.	`@Configuration` which will make it a configuration class
    2.	`@Import(JpaConfiguration.class)` which will cause it to import the JPA configuration class you will be completing next.
    3.	`@ComponentScan(basePackages="com.conygre.spring.boot")` which will cause it to scan in your DAO and Service beans.

2.	Close `AppConfig.java`, and now open `JpaConfiguration.java` located in the same package.

3.	Annotate the class with the following annotations:

```
@Configuration
@EnableTransactionManagement
@PropertySource(value = { "classpath:application.properties" })
```

4.	Declare a private field of type `Environment` called `environment`, and mark it as `@Autowired`. This property will be set by reading in an `application.properties` file you will be creating later.

```
@Autowired
private Environment environment;
```

5.	Now create a method to return a `VendorAdapter` bean to configure that our JPA class will be using Hibernate as the JPA implementation.

```
    @Bean
	public JpaVendorAdapter jpaVendorAdapter() {
		HibernateJpaVendorAdapter hibernateJpaVendorAdapter 
= new HibernateJpaVendorAdapter();
		return hibernateJpaVendorAdapter;
	}
```

6.	Now declare an `EntityManagerFactory` method that the injected `PersistenceContext` will come from.

```
    @Bean
	public LocalContainerEntityManagerFactoryBean 
entityManagerFactory() throws NamingException {
		LocalContainerEntityManagerFactoryBean factoryBean = 
new LocalContainerEntityManagerFactoryBean();
		factoryBean.setDataSource(dataSource());
		factoryBean.setPackagesToScan(
new String[] { "com.conygre.spring.entities" });
		factoryBean.setJpaVendorAdapter(jpaVendorAdapter());
		factoryBean.setJpaProperties(jpaProperties());
		return factoryBean;
	}
```

7.	Define a method to return a bean to represent the `DataSource` (we will be removing that information from persistence.xml to make the application more realistic.

```
    @Bean
	public DataSource dataSource() {
	DriverManagerDataSource dataSource = 
new DriverManagerDataSource();

dataSource.setDriverClassName(
  environment.getRequiredProperty("jdbc.driverClassName"));
		dataSource.setUrl(environment.getRequiredProperty("jdbc.url"));
	dataSource.setUsername(
environment.getRequiredProperty("jdbc.username"));
	dataSource.setPassword(
environment.getRequiredProperty("jdbc.password"));
	return dataSource;
}
```

8.	Add a method to return a `Properties` object that can provide any additional JPA configuration.

```
private Properties jpaProperties() {
		Properties properties = new Properties();
		properties.put("hibernate.dialect", environment.getRequiredProperty("hibernate.dialect"));		
		properties.put("hibernate.show_sql", environment.getRequiredProperty("hibernate.show_sql"));
		properties.put("hibernate.format_sql", environment.getRequiredProperty("hibernate.format_sql"));
		return properties;
	}
```

9.	The final method enables transactions, so add a method to return a `TransactionManager`.

```
    @Bean
	@Autowired
	public PlatformTransactionManager transactionManager(EntityManagerFactory emf) {
		JpaTransactionManager txManager = new JpaTransactionManager();
		txManager.setEntityManagerFactory(emf);
		return txManager;
	}
```

## Adding the properties file
You will need to add the properties file containing the database connection information. 

1.	In `src/main/resources`, create a new file called `application.properties`. If the resources folder is not there, simply create it using Windows explorer or Finder, or through your IDE. It is just a normal folder.

2.	In the file, add the following properties:

```
jdbc.driverClassName=com.mysql.cj.jdbc.Driver
jdbc.url=jdbc:mysql://localhost:3306/conygre?useUnicode=true&useJDBCCompliantTimezoneShift=true&useLegacyDatetimeCode=false&serverTimezone=UTC
jdbc.username=root
jdbc.password=c0nygre
hibernate.dialect=org.hibernate.dialect.MySQL8Dialect
hibernate.hbm2ddl.auto=create-drop
hibernate.show_sql=true
hibernate.format_sql=true
```

## Adding Transaction Support

The code is largely complete now, but in order for the service bean to work, Spring needs to know where to start and end the transactions.

### Configuring Our Transactional Requirements

1.	Open the `SpringJPACompactDiscDAO` class and add the required annotation to specify that all methods support a transaction.

2.	Open the `CompactDiscService` class and add an annotation to specify that all methods require a transaction.


## Creating a Test Harness

1.	Finally, open up `TestSpringJpa.java` which is in the default package, and then load up the Java configuration class using

```
ApplicationContext context = new  AnnotationConfigApplicationContext(AppConfig.class);
```

2.	Then from the `context`, obtain a reference to the service bean and then try calling the `getCatalog()` method to retrieve all of the CDs and iterate over them printing out the titles. 

3.	Run this main method, and if you have done everything correctly, it will work!

